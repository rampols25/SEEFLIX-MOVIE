<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SEEFLIX â€” Watch Movies & TV Shows</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7977700940936581"
    crossorigin="anonymous"></script>

  <!-- Custom ad script -->
  <script src="https://fpyf8.com/88/tag.min.js" data-zone="178048" async data-cfasync="false"></script>

  <style>
    html,body { height: 100%; }
    /* Episode thumb sizing (desktop) */
    .episode-thumb { width: 76px; height: 44px; object-fit: cover; border-radius: 6px; }
    .episode-item:hover { background: rgba(255,255,255,0.03); }
    .suggested-thumb { width: 84px; height: 120px; object-fit: cover; border-radius: 6px; }

    /* Mobile-specific: stacked modal, fullscreen, hide episode thumbnails */
    @media (max-width: 640px) {
      #modal .modal-inner { flex-direction: column; height: 100vh; width: 100vw; border-radius: 0; }
      #modal .w-2\\/3 { width: 100% !important; }
      #modal .w-1\\/3 { width: 100% !important; }
      #modal .w-2\\/3 iframe { height: 56vw; } /* 16:9 aspect ratio approx */
      #modal .w-1\\/3 { padding: 12px; }
      /* hide episode thumbnails on mobile (user requested) */
      .episode-thumb, #episodes-list .episode-item img, #episodes-vertical img { display: none !important; }
      /* show episode titles stacked nicely */
      #episodes-vertical .episode-row { padding: .5rem 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
      /* floating back button */
      #mobile-back { display: block; }
    }

    /* Desktop: hide mobile back */
    #mobile-back { display: none; }

    /* Ensure modal is centered on desktop */
    #modal { -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body class="bg-gray-900 text-white">

  <!-- Header -->
  <header class="bg-gray-800/80 backdrop-blur-sm sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="text-2xl font-bold text-red-500">SEEFLIX</div>
      </div>

      <div class="flex items-center gap-3">
        <input id="search-bar-top" type="text" placeholder="Search (press Enter)" aria-label="Search"
               class="px-3 py-2 rounded bg-gray-800 text-sm text-white w-56" />
        <button id="btn-open-search" class="bg-red-600 px-3 py-2 rounded text-sm">Search</button>
      </div>
    </div>
  </header>

  <!-- Banner -->
  <section id="banner" class="h-56 bg-cover bg-center flex items-end p-6">
    <div class="bg-gradient-to-t from-black/70 to-transparent w-full p-4 rounded">
      <h1 id="banner-title" class="text-3xl font-bold"></h1>
    </div>
  </section>

  <!-- Main lists -->
  <main class="max-w-7xl mx-auto px-4 py-6 space-y-8">
    <section>
      <h2 class="text-xl font-semibold mb-3">Trending Movies</h2>
      <div id="movies-list" class="flex gap-3 overflow-x-auto pb-2"></div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-3">Trending TV Shows</h2>
      <div id="tvshows-list" class="flex gap-3 overflow-x-auto pb-2"></div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-3">Trending Anime</h2>
      <div id="anime-list" class="flex gap-3 overflow-x-auto pb-2"></div>
    </section>
  </main>

  <!-- Player Modal -->
  <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 p-0">
    <div class="modal-inner bg-gray-800 rounded-lg w-[95%] max-w-[1200px] h-[85vh] flex overflow-hidden">
      <!-- Left: Player -->
      <div class="w-2/3 bg-black flex flex-col">
        <div class="flex-1">
          <iframe id="modal-video" class="w-full h-full" frameborder="0" allowfullscreen title="Player"></iframe>
        </div>

        <!-- Horizontal episodes row under the player (still shows on desktop) -->
        <div id="episodes" class="border-t border-gray-700 p-3 bg-gray-900/60 hidden">
          <div id="episodes-list" class="flex gap-3 overflow-x-auto"></div>
        </div>
      </div>

      <!-- Right: Info, Season selector, episodes vertical, suggested -->
      <div class="w-1/3 p-4 flex flex-col gap-3 overflow-y-auto">
        <div class="flex items-start gap-3">
          <img id="modal-image" class="w-28 h-40 object-cover rounded" src="" alt="Poster" />
          <div class="flex-1">
            <h3 id="modal-title" class="text-lg font-bold"></h3>
            <p id="modal-release" class="text-sm text-gray-300 mt-1"></p>
            <p id="modal-rating" class="text-sm text-yellow-400 mt-1"></p>
          </div>
        </div>

        <!-- Season selector (for TV / anime) -->
        <div id="season-block" class="space-y-2 hidden">
          <label class="text-sm text-gray-300">Season</label>
          <select id="season-select" class="w-full bg-gray-800 text-white p-2 rounded"></select>
        </div>

        <!-- Vertical episodes list with thumbnails (desktop). On mobile thumbnails are hidden via CSS -->
        <div id="episodes-vertical-block" class="space-y-2 hidden">
          <label class="text-sm text-gray-300">Episodes</label>
          <div id="episodes-vertical" class="flex flex-col gap-2 max-h-40 overflow-y-auto"></div>
        </div>

        <!-- Description -->
        <div>
          <label class="text-sm text-gray-300">Description</label>
          <p id="modal-description" class="text-sm text-gray-200 mt-1"></p>
        </div>

        <!-- Server selector -->
        <div>
          <label class="text-sm text-gray-300">Server</label>
          <select id="server-select" class="w-full bg-gray-800 p-2 rounded">
            <option value="vidsrc.cc">vidsrc.cc</option>
            <option value="vidsrc.me">vidsrc.me</option>
            <option value="player.videasy.net">player.videasy.net</option>
          </select>
        </div>

        <!-- Suggested -->
        <div>
          <label class="text-sm text-gray-300">Suggested</label>
          <div id="suggested" class="grid grid-cols-2 gap-2 mt-2 max-h-40 overflow-y-auto"></div>
        </div>

        <!-- Close -->
        <div class="mt-auto">
          <button id="close-modal" class="w-full bg-red-600 hover:bg-red-700 px-3 py-2 rounded">Close</button>
        </div>
      </div>
    </div>

    <!-- Floating mobile back button (visible only on small screens) -->
    <button id="mobile-back" class="absolute top-4 left-4 text-white bg-black/50 p-2 rounded-full shadow" title="Back">
      <!-- simple arrow -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </button>
  </div>

  <!-- Search Modal -->
  <div id="search-modal" class="fixed inset-0 z-40 hidden items-center justify-center bg-black/85 p-6">
    <div class="bg-gray-800 rounded-lg w-[95%] max-w-[1000px] h-[80vh] p-4 flex flex-col">
      <div class="flex gap-3 mb-3">
        <input id="search-input" class="flex-1 bg-gray-700 p-3 rounded text-white" placeholder="Search movies, tv or anime" />
        <button id="btn-close-search" class="bg-red-600 px-4 rounded">Close</button>
      </div>
      <div id="search-results" class="flex gap-3 overflow-x-auto"></div>
    </div>
  </div>

  <script>
    // ---- CONFIG ----
    const API_KEY = '169689830f09449f1d23896257d507db';
    const BASE_URL = 'https://api.themoviedb.org/3';
    const IMG_URL = 'https://image.tmdb.org/t/p/w500';

    // ---- STATE ----
    let currentItem = null;
    let currentEpisode = null;
    let currentSeasonNumber = null;

    // ---- HELPERS ----
    const el = id => document.getElementById(id);
    const safeImg = (path, w = 300) => path ? IMG_URL + path : `https://via.placeholder.com/${w}x${Math.round(w*1.5)}?text=No+Image`;
    const isMobile = () => window.matchMedia('(max-width:640px)').matches;

    async function fetchJSON(url){
      const r = await fetch(url);
      if (!r.ok) throw new Error('Network error');
      return await r.json();
    }

    async function fetchTrending(type){
      const data = await fetchJSON(`${BASE_URL}/trending/${type}/week?api_key=${API_KEY}`);
      return data.results || [];
    }

    async function fetchTrendingAnime(){
      let list = [];
      for (let p=1; p<=3; p++){
        const data = await fetchJSON(`${BASE_URL}/trending/tv/week?api_key=${API_KEY}&page=${p}`);
        const filtered = (data.results||[]).filter(i => i.original_language === 'ja' && (i.genre_ids||[]).includes(16));
        list = list.concat(filtered);
      }
      return list;
    }

    function renderTile(item){
      const img = document.createElement('img');
      img.src = safeImg(item.poster_path, 154);
      img.alt = item.title || item.name || 'Item';
      img.className = 'w-32 h-48 object-cover rounded cursor-pointer hover:scale-105 transition';
      img.addEventListener('click', ()=> openDetail(item));
      return img;
    }

    function displayList(items, containerId){
      const c = el(containerId);
      c.innerHTML = '';
      (items || []).forEach(i => {
        if (!i || (!i.poster_path && !i.profile_path)) return;
        c.appendChild(renderTile(i));
      });
    }

    // ---- OPEN DETAIL / MODAL ----
    async function openDetail(item){
      currentItem = item;
      currentEpisode = null;
      currentSeasonNumber = null;

      // set info
      el('modal-title').textContent = item.title || item.name || 'Untitled';
      el('modal-description').textContent = item.overview || 'No description available';
      el('modal-image').src = safeImg(item.poster_path || item.backdrop_path, 200);
      el('modal-release').textContent = item.release_date ? `Release: ${item.release_date}` : (item.first_air_date ? `First air: ${item.first_air_date}` : '');
      el('modal-rating').textContent = item.vote_average ? `Rating: ${item.vote_average}/10` : '';

      // reset UI
      el('season-block').classList.add('hidden');
      el('episodes-vertical-block').classList.add('hidden');
      el('episodes').classList.add('hidden');
      el('episodes-list').innerHTML = '';
      el('episodes-vertical').innerHTML = '';
      el('suggested').innerHTML = '';

      // set initial player (movie fallback)
      setPlayerForItem(item);

      // if tv -> load seasons/episodes and autoplay first ep
      if (item.media_type === 'tv' || item.first_air_date || item.number_of_seasons !== undefined) {
        await loadSeasonsAndEpisodes(item);
      } else {
        await loadSuggested(item);
      }

      // open modal (full-screen on mobile)
      document.body.style.overflow = 'hidden';
      el('modal').classList.remove('hidden');

      // show/hide mobile back button
      updateMobileBackVisibility();
    }

    function closeModal(){
      el('modal-video').src = '';
      el('modal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    function updateMobileBackVisibility(){
      const mobileBack = el('mobile-back');
      if (isMobile()){
        mobileBack.style.display = 'block';
      } else {
        mobileBack.style.display = 'none';
      }
    }

    // ---- PLAYER URL BUILDERS ----
    function buildEmbedUrlForMovie(server, movieId){
      if (server === 'vidsrc.cc') return `https://vidsrc.cc/v2/embed/movie/${movieId}`;
      if (server === 'vidsrc.me' || server === 'vidsrc.net') return `https://vidsrc.net/embed/movie/?tmdb=${movieId}`;
      if (server === 'player.videasy.net') return `https://player.videasy.net/movie/${movieId}`;
      return `https://vidsrc.cc/v2/embed/movie/${movieId}`;
    }

    function buildEmbedUrlForEpisode(server, tvId, seasonNumber, episodeNumber){
      if (server === 'vidsrc.cc') return `https://vidsrc.cc/v2/embed/tv/${tvId}/${seasonNumber}/${episodeNumber}`;
      if (server === 'vidsrc.me' || server === 'vidsrc.net') return `https://vidsrc.net/embed/tv/?tmdb=${tvId}&season=${seasonNumber}&episode=${episodeNumber}`;
      if (server === 'player.videasy.net') return `https://player.videasy.net/tv/${tvId}/${seasonNumber}/${episodeNumber}`;
      return `https://vidsrc.cc/v2/embed/tv/${tvId}/${seasonNumber}/${episodeNumber}`;
    }

    function setPlayerForItem(item){
      const server = el('server-select').value || 'vidsrc.cc';
      if (!item) return;
      if (item.media_type === 'movie' || item.title && !item.first_air_date) {
        const url = buildEmbedUrlForMovie(server, item.id);
        el('modal-video').src = url;
        // hide episodes area for movies
        el('episodes').classList.add('hidden');
      } else {
        // TV fallback: wait until episodes are loaded, then play first ep
        // if loadSeasonsAndEpisodes hasn't populated yet, player will be set when ep clicked or autoloaded
      }
    }

    // server change behaviour
    el('server-select').addEventListener('change', ()=>{
      if (!currentItem) return;
      if (currentEpisode){
        const url = buildEmbedUrlForEpisode(el('server-select').value, currentItem.id, currentEpisode.season_number, currentEpisode.episode_number);
        el('modal-video').src = url;
      } else {
        setPlayerForItem(currentItem);
      }
    });

    // ---- SEASONS / EPISODES ----
    async function loadSeasonsAndEpisodes(item){
      try {
        const tv = await fetchJSON(`${BASE_URL}/tv/${item.id}?api_key=${API_KEY}`);
        const seasons = tv.seasons || [];
        if (!seasons.length) return;

        // populate seasons select
        el('season-block').classList.remove('hidden');
        const sel = el('season-select');
        sel.innerHTML = '';
        seasons.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.season_number;
          opt.textContent = `Season ${s.season_number}${s.name ? ' - ' + s.name : ''}`;
          sel.appendChild(opt);
        });

        // pick first normal season (skip specials if possible)
        let firstSeason = seasons.find(s => s.season_number > 0) || seasons[0];
        if (!firstSeason) firstSeason = seasons[0];
        currentSeasonNumber = firstSeason.season_number;
        sel.value = currentSeasonNumber;

        // load episodes for that season
        await loadEpisodesForSeason(item.id, currentSeasonNumber);

        // show vertical episodes
        el('episodes-vertical-block').classList.remove('hidden');

        // season change handler
        sel.onchange = async () => {
          currentSeasonNumber = parseInt(sel.value);
          await loadEpisodesForSeason(item.id, currentSeasonNumber);
        };

        // autoplay first episode of season (if exists)
        const firstEpButton = el('episodes-vertical').querySelector('[data-ep-index]');
        if (firstEpButton) {
          firstEpButton.click();
        }
      } catch (err) {
        console.warn('Could not load seasons', err);
      }
    }

    async function loadEpisodesForSeason(tvId, seasonNumber){
      try {
        const season = await fetchJSON(`${BASE_URL}/tv/${tvId}/season/${seasonNumber}?api_key=${API_KEY}`);
        const episodes = season.episodes || [];

        // horizontal list under player
        const episodesList = el('episodes-list');
        episodesList.innerHTML = '';

        // vertical list on right
        const episodesVertical = el('episodes-vertical');
        episodesVertical.innerHTML = '';

        episodes.forEach(ep => {
          // horizontal small thumb (desktop)
          const container = document.createElement('div');
          container.className = 'flex flex-col gap-1 items-center episode-item cursor-pointer';
          const thumb = document.createElement('img');
          thumb.className = 'episode-thumb';
          thumb.src = safeImg(ep.still_path, 160);
          thumb.alt = ep.name || `E${ep.episode_number}`;
          const label = document.createElement('div');
          label.className = 'text-xs text-center text-gray-300';
          label.textContent = `E${ep.episode_number}`;
          container.appendChild(thumb);
          container.appendChild(label);
          container.addEventListener('click', () => {
            playEpisode(tvId, seasonNumber, ep);
            highlightActiveEpisode(ep.episode_number);
          });
          episodesList.appendChild(container);

          // vertical row with thumbnail + title
          const row = document.createElement('div');
          row.className = 'flex items-center gap-2 p-2 rounded episode-row cursor-pointer';
          row.innerHTML = `
            <img class="w-20 h-12 object-cover rounded" src="${safeImg(ep.still_path,160)}" alt="${(ep.name||'')}" />
            <div class="flex-1 text-sm">
              <div class="font-medium">${ep.episode_number}. ${ep.name || 'Untitled'}</div>
              <div class="text-xs text-gray-300">${ep.air_date || ''}</div>
            </div>
          `;
          row.addEventListener('click', () => {
            playEpisode(tvId, seasonNumber, ep);
            highlightActiveEpisode(ep.episode_number);
          });
          row.setAttribute('data-ep-index', ep.episode_number);
          episodesVertical.appendChild(row);
        });

        // reveal episodes area(s)
        el('episodes').classList.remove('hidden');

      } catch (err) {
        console.warn('Could not load season episodes', err);
      }
    }

    function highlightActiveEpisode(epNumber){
      document.querySelectorAll('#episodes-list .episode-item, #episodes-vertical .episode-row').forEach(n => n.classList.remove('bg-gray-700'));
      // mark vertical row
      const row = document.querySelector(`#episodes-vertical [data-ep-index="${epNumber}"]`);
      if (row) row.classList.add('bg-gray-700');
    }

    function playEpisode(tvId, seasonNumber, ep){
      currentEpisode = ep;
      currentSeasonNumber = seasonNumber;
      const server = el('server-select').value || 'vidsrc.cc';
      const url = buildEmbedUrlForEpisode(server, tvId, seasonNumber, ep.episode_number);
      el('modal-video').src = url;
      // best-effort scroll
      document.querySelector('#modal .w-2/3')?.scrollIntoView({behavior:'smooth'});
    }

    // ---- SUGGESTED ----
    async function loadSuggested(item){
      let suggested = [];
      try {
        if (item && item.id && item.media_type === 'movie'){
          const data = await fetchJSON(`${BASE_URL}/movie/${item.id}/similar?api_key=${API_KEY}`);
          suggested = data.results || [];
        }
        if (!suggested.length) suggested = await fetchTrending('movie');
      } catch {
        suggested = await fetchTrending('movie');
      }
      const container = el('suggested');
      container.innerHTML = '';
      (suggested.slice(0,6)).forEach(s => {
        if (!s) return;
        const div = document.createElement('div');
        div.className = 'flex flex-col items-center gap-1';
        const img = document.createElement('img');
        img.className = 'suggested-thumb cursor-pointer';
        img.src = safeImg(s.poster_path,160);
        img.alt = s.title || s.name;
        img.addEventListener('click', ()=> openDetail(s));
        const label = document.createElement('div');
        label.className = 'text-xs text-center';
        label.textContent = s.title || s.name;
        div.appendChild(img);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    // ---- SEARCH ----
    async function searchTMDB(query){
      if (!query || !query.trim()){
        el('search-results').innerHTML = '';
        return;
      }
      try {
        const data = await fetchJSON(`${BASE_URL}/search/multi?api_key=${API_KEY}&query=${encodeURIComponent(query)}`);
        const results = data.results || [];
        const container = el('search-results');
        container.innerHTML = '';
        results.forEach(r => {
          if (!r.poster_path) return;
          container.appendChild(renderTile(r));
        });
      } catch (err){
        console.warn('Search failed', err);
      }
    }

    // ---- INIT ----
    async function init(){
      try {
        const [movies, tv, anime] = await Promise.all([
          fetchTrending('movie'),
          fetchTrending('tv'),
          fetchTrendingAnime()
        ]);
        if (movies && movies.length){
          const random = movies[Math.floor(Math.random()*movies.length)];
          el('banner-title').textContent = random.title || random.name || '';
          document.getElementById('banner').style.backgroundImage = `linear-gradient(0deg,rgba(0,0,0,0.6),rgba(0,0,0,0.0)), url('${safeImg(random.backdrop_path,600)}')`;
        }
        displayList(movies, 'movies-list');
        displayList(tv, 'tvshows-list');
        displayList(anime, 'anime-list');
      } catch (err){
        console.error('init failed', err);
      }
    }

    // ---- EVENTS ----
    el('btn-open-search').addEventListener('click', ()=> {
      el('search-modal').classList.remove('hidden');
      el('search-input').focus();
    });
    el('btn-close-search').addEventListener('click', ()=> {
      el('search-modal').classList.add('hidden');
    });
    el('search-input').addEventListener('input', (e)=> { searchTMDB(e.target.value); });

    el('search-bar-top').addEventListener('keydown', (e)=> {
      if (e.key === 'Enter') {
        const q = e.target.value.trim();
        if (q) {
          el('search-modal').classList.remove('hidden');
          el('search-input').value = q;
          searchTMDB(q);
        }
      }
    });

    el('close-modal').addEventListener('click', closeModal);
    el('mobile-back').addEventListener('click', closeModal);

    // ESC closes modal or search
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape') {
        if (!el('modal').classList.contains('hidden')) closeModal();
        if (!el('search-modal').classList.contains('hidden')) el('search-modal').classList.add('hidden');
      }
    });

    // update mobile back button on resize orientation change
    window.addEventListener('resize', updateMobileBackVisibility);
    window.addEventListener('orientationchange', updateMobileBackVisibility);

    // initialize
    init();
  </script>
</body>
</html>
